!function(i,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Animated_GIF=t():i.Animated_GIF=t()}(self,(function(){return(()=>{"use strict";var i={494:(i,t)=>{function e(i,t,e,s){for(var a=i[t++],r=1<<a,n=r+1,h=n+1,o=a+1,m=(1<<o)-1,u=0,l=0,_=0,c=i[t++],d=new Int32Array(4096),g=null;;){for(;u<16&&0!==c;)l|=i[t++]<<u,u+=8,1===c?c=i[t++]:--c;if(u<o)break;var f=l&m;if(l>>=o,u-=o,f!==r){if(f===n)break;for(var p=f<h?f:g,M=0,b=p;b>r;)b=d[b]>>8,++M;var w=b;if(_+M+(p!==f?1:0)>s)return void console.log("Warning, gif stream longer than expected.");e[_++]=w;var x=_+=M;for(p!==f&&(e[_++]=w),b=p;M--;)b=d[b],e[--x]=255&b,b>>=8;null!==g&&h<4096&&(d[h++]=g<<8|w,h>=m+1&&o<12&&(++o,m=m<<1|1)),g=f}else h=n+1,m=(1<<(o=a+1))-1,g=null}return _!==s&&console.log("Warning, gif stream shorter than expected."),e}try{t.g=function(i,t,e,s){var a=0,r=void 0===(s=void 0===s?{}:s).loop?null:s.loop,n=void 0===s.palette?null:s.palette;if(t<=0||e<=0||t>65535||e>65535)throw new Error("Width/Height invalid.");function h(i){var t=i.length;if(t<2||t>256||t&t-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return t}i[a++]=71,i[a++]=73,i[a++]=70,i[a++]=56,i[a++]=57,i[a++]=97;var o=0,m=0;if(null!==n){for(var u=h(n);u>>=1;)++o;if(u=1<<o,--o,void 0!==s.background){if((m=s.background)>=u)throw new Error("Background index out of range.");if(0===m)throw new Error("Background index explicitly passed as 0.")}}if(i[a++]=255&t,i[a++]=t>>8&255,i[a++]=255&e,i[a++]=e>>8&255,i[a++]=(null!==n?128:0)|o,i[a++]=m,i[a++]=0,null!==n)for(var l=0,_=n.length;l<_;++l){var c=n[l];i[a++]=c>>16&255,i[a++]=c>>8&255,i[a++]=255&c}if(null!==r){if(r<0||r>65535)throw new Error("Loop count invalid.");i[a++]=33,i[a++]=255,i[a++]=11,i[a++]=78,i[a++]=69,i[a++]=84,i[a++]=83,i[a++]=67,i[a++]=65,i[a++]=80,i[a++]=69,i[a++]=50,i[a++]=46,i[a++]=48,i[a++]=3,i[a++]=1,i[a++]=255&r,i[a++]=r>>8&255,i[a++]=0}var d=!1;this.addFrame=function(t,e,s,r,o,m){if(!0===d&&(--a,d=!1),m=void 0===m?{}:m,t<0||e<0||t>65535||e>65535)throw new Error("x/y invalid.");if(s<=0||r<=0||s>65535||r>65535)throw new Error("Width/Height invalid.");if(o.length<s*r)throw new Error("Not enough pixels for the frame size.");var u=!0,l=m.palette;if(null==l&&(u=!1,l=n),null==l)throw new Error("Must supply either a local or global palette.");for(var _=h(l),c=0;_>>=1;)++c;_=1<<c;var g=void 0===m.delay?0:m.delay,f=void 0===m.disposal?0:m.disposal;if(f<0||f>3)throw new Error("Disposal out of range.");var p=!1,M=0;if(void 0!==m.transparent&&null!==m.transparent&&(p=!0,(M=m.transparent)<0||M>=_))throw new Error("Transparent color index.");if((0!==f||p||0!==g)&&(i[a++]=33,i[a++]=249,i[a++]=4,i[a++]=f<<2|(!0===p?1:0),i[a++]=255&g,i[a++]=g>>8&255,i[a++]=M,i[a++]=0),i[a++]=44,i[a++]=255&t,i[a++]=t>>8&255,i[a++]=255&e,i[a++]=e>>8&255,i[a++]=255&s,i[a++]=s>>8&255,i[a++]=255&r,i[a++]=r>>8&255,i[a++]=!0===u?128|c-1:0,!0===u)for(var b=0,w=l.length;b<w;++b){var x=l[b];i[a++]=x>>16&255,i[a++]=x>>8&255,i[a++]=255&x}return a=function(i,t,e,s){i[t++]=e;var a=t++,r=1<<e,n=r-1,h=r+1,o=h+1,m=e+1,u=0,l=0;function _(e){for(;u>=e;)i[t++]=255&l,l>>=8,u-=8,t===a+256&&(i[a]=255,a=t++)}function c(i){l|=i<<u,u+=m,_(8)}var d=s[0]&n,g={};c(r);for(var f=1,p=s.length;f<p;++f){var M=s[f]&n,b=d<<8|M,w=g[b];if(void 0===w){for(l|=d<<u,u+=m;u>=8;)i[t++]=255&l,l>>=8,u-=8,t===a+256&&(i[a]=255,a=t++);4096===o?(c(r),o=h+1,m=e+1,g={}):(o>=1<<m&&++m,g[b]=o++),d=M}else d=w}return c(d),c(h),_(1),a+1===t?i[a]=0:(i[a]=t-a-1,i[t++]=0),t}(i,a,c<2?2:c,o),a},this.end=function(){return!1===d&&(i[a++]=59,d=!0),a},this.getOutputBuffer=function(){return i},this.setOutputBuffer=function(t){i=t},this.getOutputBufferPosition=function(){return a},this.setOutputBufferPosition=function(i){a=i}},function(i){var t=0;if(71!==i[t++]||73!==i[t++]||70!==i[t++]||56!==i[t++]||56!=(i[t++]+1&253)||97!==i[t++])throw new Error("Invalid GIF 87a/89a header.");var s=i[t++]|i[t++]<<8,a=i[t++]|i[t++]<<8,r=i[t++],n=r>>7,h=1<<1+(7&r);i[t++],i[t++];var o=null,m=null;n&&(o=t,m=h,t+=3*h);var u=!0,l=[],_=0,c=null,d=0,g=null;for(this.width=s,this.height=a;u&&t<i.length;)switch(i[t++]){case 33:switch(i[t++]){case 255:if(11!==i[t]||78==i[t+1]&&69==i[t+2]&&84==i[t+3]&&83==i[t+4]&&67==i[t+5]&&65==i[t+6]&&80==i[t+7]&&69==i[t+8]&&50==i[t+9]&&46==i[t+10]&&48==i[t+11]&&3==i[t+12]&&1==i[t+13]&&0==i[t+16])t+=14,g=i[t++]|i[t++]<<8,t++;else for(t+=12;;){if(!((B=i[t++])>=0))throw Error("Invalid block size");if(0===B)break;t+=B}break;case 249:if(4!==i[t++]||0!==i[t+4])throw new Error("Invalid graphics extension block.");var f=i[t++];_=i[t++]|i[t++]<<8,c=i[t++],0==(1&f)&&(c=null),d=f>>2&7,t++;break;case 254:for(;;){if(!((B=i[t++])>=0))throw Error("Invalid block size");if(0===B)break;t+=B}break;default:throw new Error("Unknown graphic control label: 0x"+i[t-1].toString(16))}break;case 44:var p=i[t++]|i[t++]<<8,M=i[t++]|i[t++]<<8,b=i[t++]|i[t++]<<8,w=i[t++]|i[t++]<<8,x=i[t++],y=x>>6&1,S=1<<1+(7&x),k=o,z=m,A=!1;x>>7&&(A=!0,k=t,z=S,t+=3*S);var v=t;for(t++;;){var B;if(!((B=i[t++])>=0))throw Error("Invalid block size");if(0===B)break;t+=B}l.push({x:p,y:M,width:b,height:w,has_local_palette:A,palette_offset:k,palette_size:z,data_offset:v,data_length:t-v,transparent_index:c,interlaced:!!y,delay:_,disposal:d});break;case 59:u=!1;break;default:throw new Error("Unknown gif block: 0x"+i[t-1].toString(16))}this.numFrames=function(){return l.length},this.loopCount=function(){return g},this.frameInfo=function(i){if(i<0||i>=l.length)throw new Error("Frame index out of range.");return l[i]},this.decodeAndBlitFrameBGRA=function(t,a){var r=this.frameInfo(t),n=r.width*r.height,h=new Uint8Array(n);e(i,r.data_offset,h,n);var o=r.palette_offset,m=r.transparent_index;null===m&&(m=256);var u=r.width,l=s-u,_=u,c=4*(r.y*s+r.x),d=4*((r.y+r.height)*s+r.x),g=c,f=4*l;!0===r.interlaced&&(f+=4*s*7);for(var p=8,M=0,b=h.length;M<b;++M){var w=h[M];if(0===_&&(_=u,(g+=f)>=d&&(f=4*l+4*s*(p-1),g=c+(u+l)*(p<<1),p>>=1)),w===m)g+=4;else{var x=i[o+3*w],y=i[o+3*w+1],S=i[o+3*w+2];a[g++]=S,a[g++]=y,a[g++]=x,a[g++]=255}--_}},this.decodeAndBlitFrameRGBA=function(t,a){var r=this.frameInfo(t),n=r.width*r.height,h=new Uint8Array(n);e(i,r.data_offset,h,n);var o=r.palette_offset,m=r.transparent_index;null===m&&(m=256);var u=r.width,l=s-u,_=u,c=4*(r.y*s+r.x),d=4*((r.y+r.height)*s+r.x),g=c,f=4*l;!0===r.interlaced&&(f+=4*s*7);for(var p=8,M=0,b=h.length;M<b;++M){var w=h[M];if(0===_&&(_=u,(g+=f)>=d&&(f=4*l+4*s*(p-1),g=c+(u+l)*(p<<1),p>>=1)),w===m)g+=4;else{var x=i[o+3*w],y=i[o+3*w+1],S=i[o+3*w+2];a[g++]=x,a[g++]=y,a[g++]=S,a[g++]=255}--_}}}}catch(i){}},477:i=>{i.exports=function(i,t,e,s){var a=self||window;try{try{var r;try{r=new a.Blob([i])}catch(t){(r=new(a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||a.MSBlobBuilder)).append(i),r=r.getBlob()}var n=a.URL||a.webkitURL,h=n.createObjectURL(r),o=new a[t](h,e);return n.revokeObjectURL(h),o}catch(s){return new a[t]("data:application/javascript,".concat(encodeURIComponent(i)),e)}}catch(i){if(!s)throw Error("Inline worker is not supported");return new a[t](s,e)}}}},t={};function e(s){var a=t[s];if(void 0!==a)return a.exports;var r=t[s]={exports:{}};return i[s](r,r.exports,e),r.exports}e.n=i=>{var t=i&&i.__esModule?()=>i.default:()=>i;return e.d(t,{a:t}),t},e.d=(i,t)=>{for(var s in t)e.o(t,s)&&!e.o(i,s)&&Object.defineProperty(i,s,{enumerable:!0,get:t[s]})},e.o=(i,t)=>Object.prototype.hasOwnProperty.call(i,t),e.r=i=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})};var s={};return(()=>{e.r(s),e.d(s,{default:()=>n});var i=e(494),t=e(477),a=e.n(t);function r(){return a()('(()=>{"use strict";var i=Object.defineProperty,t=(t,e)=>{for(var s in e)i(t,s,{get:e[s],enumerable:!0})},e=(t,e,s)=>(((t,e,s)=>{e in t?i(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s})(t,"symbol"!=typeof e?e+"":e,s),s);t({},{bt709:()=>s});var s={};t(s,{Y:()=>a,x:()=>r,y:()=>n});var a=(i=>(i[i.RED=.2126]="RED",i[i.GREEN=.7152]="GREEN",i[i.BLUE=.0722]="BLUE",i[i.WHITE=1]="WHITE",i))(a||{}),r=(i=>(i[i.RED=.64]="RED",i[i.GREEN=.3]="GREEN",i[i.BLUE=.15]="BLUE",i[i.WHITE=.3127]="WHITE",i))(r||{}),n=(i=>(i[i.RED=.33]="RED",i[i.GREEN=.6]="GREEN",i[i.BLUE=.06]="BLUE",i[i.WHITE=.329]="WHITE",i))(n||{});function h(i){return i>.04045?((i+.055)/1.055)**2.4:i/12.92}function m(i,t,e){return{x:.4124*(i=h(i/255))+.3576*(t=h(t/255))+.1805*(e=h(e/255)),y:.2126*i+.7152*t+.0722*e,z:.0193*i+.1192*t+.9505*e}}t({},{lab2rgb:()=>z,lab2xyz:()=>S,rgb2hsl:()=>p,rgb2lab:()=>x,rgb2xyz:()=>m,xyz2lab:()=>f,xyz2rgb:()=>k});var u={};function o(i){return i*(Math.PI/180)}function l(i,t,e){let s=i;return s<t&&(s=t),s<e&&(s=e),s}function _(i,t,e){let s=i;return s>t&&(s=t),s>e&&(s=e),s}function c(i,t,e){return i>e&&(i=e),i<t&&(i=t),0|i}function d(i){return(i=Math.round(i))>255?i=255:i<0&&(i=0),i}function g(i){return i>255?i=255:i<0&&(i=0),i}function M(i,t){const e=typeof i[0];let s;if("number"===e||"string"===e){const e=Object.create(null);for(let t=0,s=i.length;t<s;t++){const s=i[t];e[s]||0===e[s]||(e[s]=t)}s=i.sort(((i,s)=>t(i,s)||e[i]-e[s]))}else{const e=i.slice(0);s=i.sort(((i,s)=>t(i,s)||e.indexOf(i)-e.indexOf(s)))}return s}function p(i,t,e){const s=_(i,t,e),a=l(i,t,e),r=a-s,n=(s+a)/510;let h=0;n>0&&n<1&&(h=r/(n<.5?a+s:510-a-s));let m=0;return r>0&&(m=a===i?(t-e)/r:a===t?2+(e-i)/r:4+(i-t)/r,m*=60,m<0&&(m+=360)),{h:m,s:h,l:n}}t(u,{degrees2radians:()=>o,inRange0to255:()=>g,inRange0to255Rounded:()=>d,intInRange:()=>c,max3:()=>l,min3:()=>_,stableSort:()=>M});function b(i){return i>.008856?i**(1/3):7.787*i+16/116}function f(i,t,e){if(i=b(i/.95047),t=b(t/1),e=b(e/1.08883),116*t-16<0)throw new Error("xxx");return{L:Math.max(0,116*t-16),a:500*(i-t),b:200*(t-e)}}function x(i,t,e){const s=m(i,t,e);return f(s.x,s.y,s.z)}function w(i){return i>.206893034?i**3:(i-16/116)/7.787}function S(i,t,e){const s=(i+16)/116,a=s-e/200;return{x:.95047*w(t/500+s),y:1*w(s),z:1.08883*w(a)}}function y(i){return i>.0031308?1.055*i**(1/2.4)-.055:12.92*i}function k(i,t,e){const s=y(3.2406*i+-1.5372*t+-.4986*e),a=y(-.9689*i+1.8758*t+.0415*e),r=y(.0557*i+-.204*t+1.057*e);return{r:d(255*s),g:d(255*a),b:d(255*r)}}function z(i,t,e){const s=S(i,t,e);return k(s.x,s.y,s.z)}t({},{AbstractDistanceCalculator:()=>A,AbstractEuclidean:()=>v,AbstractManhattan:()=>N,CIE94GraphicArts:()=>R,CIE94Textiles:()=>P,CIEDE2000:()=>E,CMetric:()=>C,Euclidean:()=>D,EuclideanBT709:()=>G,EuclideanBT709NoAlpha:()=>q,Manhattan:()=>U,ManhattanBT709:()=>Q,ManhattanNommyde:()=>L,PNGQuant:()=>T});var A=class{constructor(){e(this,"_maxDistance"),e(this,"_whitePoint"),this._setDefaults(),this.setWhitePoint(255,255,255,255)}setWhitePoint(i,t,e,s){this._whitePoint={r:i>0?255/i:0,g:t>0?255/t:0,b:e>0?255/e:0,a:s>0?255/s:0},this._maxDistance=this.calculateRaw(i,t,e,s,0,0,0,0)}calculateNormalized(i,t){return this.calculateRaw(i.r,i.g,i.b,i.a,t.r,t.g,t.b,t.a)/this._maxDistance}},B=class extends A{calculateRaw(i,t,e,s,a,r,n,h){const m=x(g(i*this._whitePoint.r),g(t*this._whitePoint.g),g(e*this._whitePoint.b)),u=x(g(a*this._whitePoint.r),g(r*this._whitePoint.g),g(n*this._whitePoint.b)),o=m.L-u.L,l=m.a-u.a,_=m.b-u.b,c=Math.sqrt(m.a*m.a+m.b*m.b),d=c-Math.sqrt(u.a*u.a+u.b*u.b);let M=l*l+_*_-d*d;M=M<0?0:Math.sqrt(M);const p=(h-s)*this._whitePoint.a*this._kA;return Math.sqrt((o/this._Kl)**2+(d/(1+this._K1*c))**2+(M/(1+this._K2*c))**2+p**2)}},P=class extends B{_setDefaults(){this._Kl=2,this._K1=.048,this._K2=.014,this._kA=12.5/255}},R=class extends B{_setDefaults(){this._Kl=1,this._K1=.045,this._K2=.015,this._kA=25/255}},I=class extends A{_setDefaults(){}static _calculatehp(i,t){const e=Math.atan2(i,t);return e>=0?e:e+I._deg360InRad}static _calculateRT(i,t){const e=t**7,s=2*Math.sqrt(e/(e+I._pow25to7)),a=I._deg30InRad*Math.exp(-(((i-I._deg275InRad)/I._deg25InRad)**2));return-Math.sin(2*a)*s}static _calculateT(i){return 1-.17*Math.cos(i-I._deg30InRad)+.24*Math.cos(2*i)+.32*Math.cos(3*i+I._deg6InRad)-.2*Math.cos(4*i-I._deg63InRad)}static _calculate_ahp(i,t,e,s){const a=e+s;return 0===i?a:t<=I._deg180InRad?a/2:a<I._deg360InRad?(a+I._deg360InRad)/2:(a-I._deg360InRad)/2}static _calculate_dHp(i,t,e,s){let a;return a=0===i?0:t<=I._deg180InRad?e-s:e<=s?e-s+I._deg360InRad:e-s-I._deg360InRad,2*Math.sqrt(i)*Math.sin(a/2)}calculateRaw(i,t,e,s,a,r,n,h){const m=x(g(i*this._whitePoint.r),g(t*this._whitePoint.g),g(e*this._whitePoint.b)),u=x(g(a*this._whitePoint.r),g(r*this._whitePoint.g),g(n*this._whitePoint.b)),o=(h-s)*this._whitePoint.a*I._kA,l=this.calculateRawInLab(m,u);return Math.sqrt(l+o*o)}calculateRawInLab(i,t){const e=i.L,s=i.a,a=i.b,r=t.L,n=t.a,h=t.b,m=((Math.sqrt(s*s+a*a)+Math.sqrt(n*n+h*h))/2)**7,u=.5*(1-Math.sqrt(m/(m+I._pow25to7))),o=(1+u)*s,l=(1+u)*n,_=Math.sqrt(o*o+a*a),c=Math.sqrt(l*l+h*h),d=_*c,g=I._calculatehp(a,o),M=I._calculatehp(h,l),p=Math.abs(g-M),b=r-e,f=c-_,x=I._calculate_dHp(d,p,M,g),w=I._calculate_ahp(d,p,g,M),S=(_+c)/2,y=((e+r)/2-50)**2,k=f/(1+.045*S),z=x/(1+.015*I._calculateT(w)*S);return(b/(1+.015*y/Math.sqrt(20+y)))**2+k**2+z**2+I._calculateRT(w,S)*k*z}},E=I;e(E,"_kA",25/255),e(E,"_pow25to7",25**7),e(E,"_deg360InRad",o(360)),e(E,"_deg180InRad",o(180)),e(E,"_deg30InRad",o(30)),e(E,"_deg6InRad",o(6)),e(E,"_deg63InRad",o(63)),e(E,"_deg275InRad",o(275)),e(E,"_deg25InRad",o(25));var C=class extends A{calculateRaw(i,t,e,s,a,r,n,h){const m=(i+a)/2*this._whitePoint.r,u=(i-a)*this._whitePoint.r,o=(t-r)*this._whitePoint.g,l=(e-n)*this._whitePoint.b,_=((512+m)*u*u>>8)+4*o*o+((767-m)*l*l>>8),c=(h-s)*this._whitePoint.a;return Math.sqrt(_+c*c)}_setDefaults(){}},v=class extends A{calculateRaw(i,t,e,s,a,r,n,h){const m=a-i,u=r-t,o=n-e,l=h-s;return Math.sqrt(this._kR*m*m+this._kG*u*u+this._kB*o*o+this._kA*l*l)}},D=class extends v{_setDefaults(){this._kR=1,this._kG=1,this._kB=1,this._kA=1}},G=class extends v{_setDefaults(){this._kR=.2126,this._kG=.7152,this._kB=.0722,this._kA=1}},q=class extends v{_setDefaults(){this._kR=.2126,this._kG=.7152,this._kB=.0722,this._kA=0}},N=class extends A{calculateRaw(i,t,e,s,a,r,n,h){let m=a-i,u=r-t,o=n-e,l=h-s;return m<0&&(m=0-m),u<0&&(u=0-u),o<0&&(o=0-o),l<0&&(l=0-l),this._kR*m+this._kG*u+this._kB*o+this._kA*l}},U=class extends N{_setDefaults(){this._kR=1,this._kG=1,this._kB=1,this._kA=1}},L=class extends N{_setDefaults(){this._kR=.4984,this._kG=.8625,this._kB=.2979,this._kA=1}},Q=class extends N{_setDefaults(){this._kR=.2126,this._kG=.7152,this._kB=.0722,this._kA=1}},T=class extends A{calculateRaw(i,t,e,s,a,r,n,h){const m=(h-s)*this._whitePoint.a;return this._colordifferenceCh(i*this._whitePoint.r,a*this._whitePoint.r,m)+this._colordifferenceCh(t*this._whitePoint.g,r*this._whitePoint.g,m)+this._colordifferenceCh(e*this._whitePoint.b,n*this._whitePoint.b,m)}_colordifferenceCh(i,t,e){const s=i-t,a=s+e;return s*s+a*a}_setDefaults(){}};t({},{AbstractPaletteQuantizer:()=>H,ColorHistogram:()=>ri,NeuQuant:()=>ii,NeuQuantFloat:()=>si,RGBQuant:()=>hi,WuColorCube:()=>ci,WuQuant:()=>gi});var H=class{quantizeSync(){for(const i of this.quantize())if(i.palette)return i.palette;throw new Error("unreachable")}},W=class{constructor(){e(this,"r"),e(this,"g"),e(this,"b"),e(this,"a"),e(this,"uint32"),e(this,"rgba"),this.uint32=-1>>>0,this.r=this.g=this.b=this.a=0,this.rgba=new Array(4),this.rgba[0]=0,this.rgba[1]=0,this.rgba[2]=0,this.rgba[3]=0}static createByQuadruplet(i){const t=new W;return t.r=0|i[0],t.g=0|i[1],t.b=0|i[2],t.a=0|i[3],t._loadUINT32(),t._loadQuadruplet(),t}static createByRGBA(i,t,e,s){const a=new W;return a.r=0|i,a.g=0|t,a.b=0|e,a.a=0|s,a._loadUINT32(),a._loadQuadruplet(),a}static createByUint32(i){const t=new W;return t.uint32=i>>>0,t._loadRGBA(),t._loadQuadruplet(),t}from(i){this.r=i.r,this.g=i.g,this.b=i.b,this.a=i.a,this.uint32=i.uint32,this.rgba[0]=i.r,this.rgba[1]=i.g,this.rgba[2]=i.b,this.rgba[3]=i.a}getLuminosity(i){let t=this.r,e=this.g,s=this.b;return i&&(t=Math.min(255,255-this.a+this.a*t/255),e=Math.min(255,255-this.a+this.a*e/255),s=Math.min(255,255-this.a+this.a*s/255)),.2126*t+.7152*e+.0722*s}_loadUINT32(){this.uint32=(this.a<<24|this.b<<16|this.g<<8|this.r)>>>0}_loadRGBA(){this.r=255&this.uint32,this.g=this.uint32>>>8&255,this.b=this.uint32>>>16&255,this.a=this.uint32>>>24&255}_loadQuadruplet(){this.rgba[0]=this.r,this.rgba[1]=this.g,this.rgba[2]=this.b,this.rgba[3]=this.a}},F=class{constructor(){e(this,"_pointArray"),e(this,"_width"),e(this,"_height"),this._width=0,this._height=0,this._pointArray=[]}getWidth(){return this._width}getHeight(){return this._height}setWidth(i){this._width=i}setHeight(i){this._height=i}getPointArray(){return this._pointArray}clone(){const i=new F;i._width=this._width,i._height=this._height;for(let t=0,e=this._pointArray.length;t<e;t++)i._pointArray[t]=W.createByUint32(0|this._pointArray[t].uint32);return i}toUint32Array(){const i=this._pointArray.length,t=new Uint32Array(i);for(let e=0;e<i;e++)t[e]=this._pointArray[e].uint32;return t}toUint8Array(){return new Uint8Array(this.toUint32Array().buffer)}static fromHTMLImageElement(i){const t=i.naturalWidth,e=i.naturalHeight,s=document.createElement("canvas");s.width=t,s.height=e;return s.getContext("2d").drawImage(i,0,0,t,e,0,0,t,e),F.fromHTMLCanvasElement(s)}static fromHTMLCanvasElement(i){const t=i.width,e=i.height,s=i.getContext("2d").getImageData(0,0,t,e);return F.fromImageData(s)}static fromImageData(i){const t=i.width,e=i.height;return F.fromUint8Array(i.data,t,e)}static fromUint8Array(i,t,e){switch(Object.prototype.toString.call(i)){case"[object Uint8ClampedArray]":case"[object Uint8Array]":break;default:i=new Uint8Array(i)}const s=new Uint32Array(i.buffer);return F.fromUint32Array(s,t,e)}static fromUint32Array(i,t,e){const s=new F;s._width=t,s._height=e;for(let t=0,e=i.length;t<e;t++)s._pointArray[t]=W.createByUint32(0|i[t]);return s}static fromBuffer(i,t,e){const s=new Uint32Array(i.buffer,i.byteOffset,i.byteLength/Uint32Array.BYTES_PER_ELEMENT);return F.fromUint32Array(s,t,e)}};function j(i,t){const e=360/t;for(let s=1,a=e-e/2;s<t;s++,a+=e)if(i>=a&&i<a+e)return s;return 0}var K=class{constructor(){e(this,"_pointContainer"),e(this,"_pointArray",[]),e(this,"_i32idx",{}),this._pointContainer=new F,this._pointContainer.setHeight(1),this._pointArray=this._pointContainer.getPointArray()}add(i){this._pointArray.push(i),this._pointContainer.setWidth(this._pointArray.length)}has(i){for(let t=this._pointArray.length-1;t>=0;t--)if(i.uint32===this._pointArray[t].uint32)return!0;return!1}getNearestColor(i,t){return this._pointArray[0|this._getNearestIndex(i,t)]}getPointContainer(){return this._pointContainer}_nearestPointFromCache(i){return"number"==typeof this._i32idx[i]?this._i32idx[i]:-1}_getNearestIndex(i,t){let e=this._nearestPointFromCache(""+t.uint32);if(e>=0)return e;let s=Number.MAX_VALUE;e=0;for(let a=0,r=this._pointArray.length;a<r;a++){const r=this._pointArray[a],n=i.calculateRaw(t.r,t.g,t.b,t.a,r.r,r.g,r.b,r.a);n<s&&(s=n,e=a)}return this._i32idx[t.uint32]=e,e}sort(){this._i32idx={},this._pointArray.sort(((i,t)=>{const e=p(i.r,i.g,i.b),s=p(t.r,t.g,t.b),a=i.r===i.g&&i.g===i.b?0:1+j(e.h,10),r=(t.r===t.g&&t.g===t.b?0:1+j(s.h,10))-a;if(r)return-r;const n=i.getLuminosity(!0),h=t.getLuminosity(!0);if(h-n!=0)return h-n;const m=(100*s.s|0)-(100*e.s|0);return m?-m:0}))}},O={};t(O,{HueStatistics:()=>X,Palette:()=>K,Point:()=>W,PointContainer:()=>F,ProgressTracker:()=>J,arithmetic:()=>u});var V=class{constructor(){e(this,"num",0),e(this,"cols",[])}},X=class{constructor(i,t){e(this,"_numGroups"),e(this,"_minCols"),e(this,"_stats"),e(this,"_groupsFull"),this._numGroups=i,this._minCols=t,this._stats=[];for(let t=0;t<=i;t++)this._stats[t]=new V;this._groupsFull=0}check(i){this._groupsFull===this._numGroups+1&&(this.check=()=>{});const t=255&i,e=i>>>8&255,s=i>>>16&255,a=t===e&&e===s?0:1+j(p(t,e,s).h,this._numGroups),r=this._stats[a],n=this._minCols;r.num++,r.num>n||(r.num===n&&this._groupsFull++,r.num<=n&&this._stats[a].cols.push(i))}injectIntoDictionary(i){for(let t=0;t<=this._numGroups;t++)this._stats[t].num<=this._minCols&&this._stats[t].cols.forEach((t=>{i[t]?i[t]++:i[t]=1}))}injectIntoArray(i){for(let t=0;t<=this._numGroups;t++)this._stats[t].num<=this._minCols&&this._stats[t].cols.forEach((t=>{-1===i.indexOf(t)&&i.push(t)}))}},$=class{constructor(i,t){e(this,"progress"),e(this,"_step"),e(this,"_range"),e(this,"_last"),e(this,"_progressRange"),this._range=i,this._progressRange=t,this._step=Math.max(1,this._range/($.steps+1)|0),this._last=-this._step,this.progress=0}shouldNotify(i){return i-this._last>=this._step&&(this._last=i,this.progress=Math.min(this._progressRange*this._last/this._range,this._progressRange),!0)}},J=$;e(J,"steps",100);var Y=class{constructor(i){e(this,"r"),e(this,"g"),e(this,"b"),e(this,"a"),this.r=this.g=this.b=this.a=i}toPoint(){return W.createByRGBA(this.r>>3,this.g>>3,this.b>>3,this.a>>3)}subtract(i,t,e,s){this.r-=0|i,this.g-=0|t,this.b-=0|e,this.a-=0|s}},Z=class extends H{constructor(i,t=256){super(),e(this,"_pointArray"),e(this,"_networkSize"),e(this,"_network"),e(this,"_sampleFactor"),e(this,"_radPower"),e(this,"_freq"),e(this,"_bias"),e(this,"_distance"),this._distance=i,this._pointArray=[],this._sampleFactor=1,this._networkSize=t,this._distance.setWhitePoint(2040,2040,2040,2040)}sample(i){this._pointArray=this._pointArray.concat(i.getPointArray())}*quantize(){this._init(),yield*this._learn(),yield{palette:this._buildPalette(),progress:100}}_init(){this._freq=[],this._bias=[],this._radPower=[],this._network=[];for(let i=0;i<this._networkSize;i++)this._network[i]=new Y((i<<11)/this._networkSize|0),this._freq[i]=Z._initialBias/this._networkSize|0,this._bias[i]=0}*_learn(){let i=this._sampleFactor;const t=this._pointArray.length;t<Z._minpicturebytes&&(i=1);const e=30+(i-1)/3|0,s=t/i|0;let a,r=s/Z._nCycles|0,n=Z._initAlpha,h=(this._networkSize>>3)*Z._radiusBias,m=h>>Z._radiusBiasShift;m<=1&&(m=0);for(let i=0;i<m;i++)this._radPower[i]=n*((m*m-i*i)*Z._radBias/(m*m))>>>0;a=t<Z._minpicturebytes?1:t%Z._prime1!=0?Z._prime1:t%Z._prime2!=0?Z._prime2:t%Z._prime3!=0?Z._prime3:Z._prime4;const u=new J(s,99);for(let i=0,o=0;i<s;){u.shouldNotify(i)&&(yield{progress:u.progress});const s=this._pointArray[o],l=s.b<<3,_=s.g<<3,c=s.r<<3,d=s.a<<3,g=this._contest(l,_,c,d);if(this._alterSingle(n,g,l,_,c,d),0!==m&&this._alterNeighbour(m,g,l,_,c,d),o+=a,o>=t&&(o-=t),i++,0===r&&(r=1),i%r==0){n-=n/e|0,h-=h/Z._radiusDecrease|0,m=h>>Z._radiusBiasShift,m<=1&&(m=0);for(let i=0;i<m;i++)this._radPower[i]=n*((m*m-i*i)*Z._radBias/(m*m))>>>0}}}_buildPalette(){const i=new K;return this._network.forEach((t=>{i.add(t.toPoint())})),i.sort(),i}_alterNeighbour(i,t,e,s,a,r){let n=t-i;n<-1&&(n=-1);let h=t+i;h>this._networkSize&&(h=this._networkSize);let m=t+1,u=t-1,o=1;for(;m<h||u>n;){const i=this._radPower[o++]/Z._alphaRadBias;if(m<h){const t=this._network[m++];t.subtract(i*(t.r-a),i*(t.g-s),i*(t.b-e),i*(t.a-r))}if(u>n){const t=this._network[u--];t.subtract(i*(t.r-a),i*(t.g-s),i*(t.b-e),i*(t.a-r))}}}_alterSingle(i,t,e,s,a,r){i/=Z._initAlpha;const n=this._network[t];n.subtract(i*(n.r-a),i*(n.g-s),i*(n.b-e),i*(n.a-r))}_contest(i,t,e,s){let a=~(1<<31),r=a,n=-1,h=n;for(let m=0;m<this._networkSize;m++){const u=this._network[m],o=8160*this._distance.calculateNormalized(u,{r:e,g:t,b:i,a:s})|0;o<a&&(a=o,n=m);const l=o-(this._bias[m]>>Z._initialBiasShift-3);l<r&&(r=l,h=m);const _=this._freq[m]>>Z._betaShift;this._freq[m]-=_,this._bias[m]+=_<<Z._gammaShift}return this._freq[n]+=Z._beta,this._bias[n]-=Z._betaGamma,h}},ii=Z;e(ii,"_prime1",499),e(ii,"_prime2",491),e(ii,"_prime3",487),e(ii,"_prime4",503),e(ii,"_minpicturebytes",Z._prime4),e(ii,"_nCycles",100),e(ii,"_initialBiasShift",16),e(ii,"_initialBias",1<<Z._initialBiasShift),e(ii,"_gammaShift",10),e(ii,"_betaShift",10),e(ii,"_beta",Z._initialBias>>Z._betaShift),e(ii,"_betaGamma",Z._initialBias<<Z._gammaShift-Z._betaShift),e(ii,"_radiusBiasShift",6),e(ii,"_radiusBias",1<<Z._radiusBiasShift),e(ii,"_radiusDecrease",30),e(ii,"_alphaBiasShift",10),e(ii,"_initAlpha",1<<Z._alphaBiasShift),e(ii,"_radBiasShift",8),e(ii,"_radBias",1<<Z._radBiasShift),e(ii,"_alphaRadBiasShift",Z._alphaBiasShift+Z._radBiasShift),e(ii,"_alphaRadBias",1<<Z._alphaRadBiasShift);var ti=class{constructor(i){e(this,"r"),e(this,"g"),e(this,"b"),e(this,"a"),this.r=this.g=this.b=this.a=i}toPoint(){return W.createByRGBA(this.r>>3,this.g>>3,this.b>>3,this.a>>3)}subtract(i,t,e,s){this.r-=i,this.g-=t,this.b-=e,this.a-=s}},ei=class extends H{constructor(i,t=256){super(),e(this,"_pointArray"),e(this,"_networkSize"),e(this,"_network"),e(this,"_sampleFactor"),e(this,"_radPower"),e(this,"_freq"),e(this,"_bias"),e(this,"_distance"),this._distance=i,this._pointArray=[],this._sampleFactor=1,this._networkSize=t,this._distance.setWhitePoint(2040,2040,2040,2040)}sample(i){this._pointArray=this._pointArray.concat(i.getPointArray())}*quantize(){this._init(),yield*this._learn(),yield{palette:this._buildPalette(),progress:100}}_init(){this._freq=[],this._bias=[],this._radPower=[],this._network=[];for(let i=0;i<this._networkSize;i++)this._network[i]=new ti((i<<11)/this._networkSize),this._freq[i]=ei._initialBias/this._networkSize,this._bias[i]=0}*_learn(){let i=this._sampleFactor;const t=this._pointArray.length;t<ei._minpicturebytes&&(i=1);const e=30+(i-1)/3,s=t/i;let a,r=s/ei._nCycles|0,n=ei._initAlpha,h=(this._networkSize>>3)*ei._radiusBias,m=h>>ei._radiusBiasShift;m<=1&&(m=0);for(let i=0;i<m;i++)this._radPower[i]=n*((m*m-i*i)*ei._radBias/(m*m));a=t<ei._minpicturebytes?1:t%ei._prime1!=0?ei._prime1:t%ei._prime2!=0?ei._prime2:t%ei._prime3!=0?ei._prime3:ei._prime4;const u=new J(s,99);for(let i=0,o=0;i<s;){u.shouldNotify(i)&&(yield{progress:u.progress});const s=this._pointArray[o],l=s.b<<3,_=s.g<<3,c=s.r<<3,d=s.a<<3,g=this._contest(l,_,c,d);if(this._alterSingle(n,g,l,_,c,d),0!==m&&this._alterNeighbour(m,g,l,_,c,d),o+=a,o>=t&&(o-=t),i++,0===r&&(r=1),i%r==0){n-=n/e,h-=h/ei._radiusDecrease,m=h>>ei._radiusBiasShift,m<=1&&(m=0);for(let i=0;i<m;i++)this._radPower[i]=n*((m*m-i*i)*ei._radBias/(m*m))}}}_buildPalette(){const i=new K;return this._network.forEach((t=>{i.add(t.toPoint())})),i.sort(),i}_alterNeighbour(i,t,e,s,a,r){let n=t-i;n<-1&&(n=-1);let h=t+i;h>this._networkSize&&(h=this._networkSize);let m=t+1,u=t-1,o=1;for(;m<h||u>n;){const i=this._radPower[o++]/ei._alphaRadBias;if(m<h){const t=this._network[m++];t.subtract(i*(t.r-a),i*(t.g-s),i*(t.b-e),i*(t.a-r))}if(u>n){const t=this._network[u--];t.subtract(i*(t.r-a),i*(t.g-s),i*(t.b-e),i*(t.a-r))}}}_alterSingle(i,t,e,s,a,r){i/=ei._initAlpha;const n=this._network[t];n.subtract(i*(n.r-a),i*(n.g-s),i*(n.b-e),i*(n.a-r))}_contest(i,t,e,s){let a=~(1<<31),r=a,n=-1,h=n;for(let m=0;m<this._networkSize;m++){const u=this._network[m],o=8160*this._distance.calculateNormalized(u,{r:e,g:t,b:i,a:s});o<a&&(a=o,n=m);const l=o-(this._bias[m]>>ei._initialBiasShift-3);l<r&&(r=l,h=m);const _=this._freq[m]>>ei._betaShift;this._freq[m]-=_,this._bias[m]+=_<<ei._gammaShift}return this._freq[n]+=ei._beta,this._bias[n]-=ei._betaGamma,h}},si=ei;e(si,"_prime1",499),e(si,"_prime2",491),e(si,"_prime3",487),e(si,"_prime4",503),e(si,"_minpicturebytes",ei._prime4),e(si,"_nCycles",100),e(si,"_initialBiasShift",16),e(si,"_initialBias",1<<ei._initialBiasShift),e(si,"_gammaShift",10),e(si,"_betaShift",10),e(si,"_beta",ei._initialBias>>ei._betaShift),e(si,"_betaGamma",ei._initialBias<<ei._gammaShift-ei._betaShift),e(si,"_radiusBiasShift",6),e(si,"_radiusBias",1<<ei._radiusBiasShift),e(si,"_radiusDecrease",30),e(si,"_alphaBiasShift",10),e(si,"_initAlpha",1<<ei._alphaBiasShift),e(si,"_radBiasShift",8),e(si,"_radBias",1<<ei._radBiasShift),e(si,"_alphaRadBiasShift",ei._alphaBiasShift+ei._radBiasShift),e(si,"_alphaRadBias",1<<ei._alphaRadBiasShift);var ai=class{constructor(i,t){e(this,"_method"),e(this,"_hueStats"),e(this,"_histogram"),e(this,"_initColors"),e(this,"_minHueCols"),this._method=i,this._minHueCols=t<<2,this._initColors=t<<2,this._hueStats=new X(ai._hueGroups,this._minHueCols),this._histogram=Object.create(null)}sample(i){switch(this._method){case 1:this._colorStats1D(i);break;case 2:this._colorStats2D(i)}}getImportanceSortedColorsIDXI32(){const i=M(Object.keys(this._histogram),((i,t)=>this._histogram[t]-this._histogram[i]));if(0===i.length)return[];let t;switch(this._method){case 1:const e=Math.min(i.length,this._initColors),s=i[e-1],a=this._histogram[s];t=i.slice(0,e);let r=e;const n=i.length;for(;r<n&&this._histogram[i[r]]===a;)t.push(i[r++]);this._hueStats.injectIntoArray(t);break;case 2:t=i;break;default:throw new Error("Incorrect method")}return t.map((i=>+i))}_colorStats1D(i){const t=this._histogram,e=i.getPointArray(),s=e.length;for(let i=0;i<s;i++){const s=e[i].uint32;this._hueStats.check(s),s in t?t[s]++:t[s]=1}}_colorStats2D(i){const t=i.getWidth(),e=i.getHeight(),s=i.getPointArray(),a=ai._boxSize[0],r=ai._boxSize[1],n=a*r,h=this._makeBoxes(t,e,a,r),m=this._histogram;h.forEach((i=>{let e=Math.round(i.w*i.h/n)*ai._boxPixels;e<2&&(e=2);const a={};this._iterateBox(i,t,(i=>{const t=s[i].uint32;this._hueStats.check(t),t in m?m[t]++:t in a?++a[t]>=e&&(m[t]=a[t]):a[t]=1}))})),this._hueStats.injectIntoDictionary(m)}_iterateBox(i,t,e){const s=i,a=s.y*t+s.x,r=(s.y+s.h-1)*t+(s.x+s.w-1),n=t-s.w+1;let h=0,m=a;do{e.call(this,m),m+=++h%s.w==0?n:1}while(m<=r)}_makeBoxes(i,t,e,s){const a=i%e,r=t%s,n=i-a,h=t-r,m=[];for(let u=0;u<t;u+=s)for(let t=0;t<i;t+=e)m.push({x:t,y:u,w:t===n?a:e,h:u===h?r:s});return m}},ri=ai;e(ri,"_boxSize",[64,64]),e(ri,"_boxPixels",2),e(ri,"_hueGroups",10);var ni=class{constructor(i,t,s){e(this,"index"),e(this,"color"),e(this,"distance"),this.index=i,this.color=t,this.distance=s}},hi=class extends H{constructor(i,t=256,s=2){super(),e(this,"_colors"),e(this,"_initialDistance"),e(this,"_distanceIncrement"),e(this,"_histogram"),e(this,"_distance"),this._distance=i,this._colors=t,this._histogram=new ri(s,t),this._initialDistance=.01,this._distanceIncrement=.005}sample(i){this._histogram.sample(i)}*quantize(){const i=this._histogram.getImportanceSortedColorsIDXI32();if(0===i.length)throw new Error("No colors in image");yield*this._buildPalette(i)}*_buildPalette(i){const t=new K,e=t.getPointContainer().getPointArray(),s=new Array(i.length);for(let t=0;t<i.length;t++)e.push(W.createByUint32(i[t])),s[t]=1;const a=e.length,r=[];let n=a,h=this._initialDistance;const m=new J(n-this._colors,99);for(;n>this._colors;){r.length=0;for(let i=0;i<a;i++){if(m.shouldNotify(a-n)&&(yield{progress:m.progress}),0===s[i])continue;const t=e[i];for(let m=i+1;m<a;m++){if(0===s[m])continue;const i=e[m],a=this._distance.calculateNormalized(t,i);a<h&&(r.push(new ni(m,i,a)),s[m]=0,n--)}}h+=n>3*this._colors?this._initialDistance:this._distanceIncrement}if(n<this._colors){M(r,((i,t)=>t.distance-i.distance));let i=0;for(;n<this._colors&&i<r.length;){s[r[i].index]=1,n++,i++}}let u=e.length;for(let i=u-1;i>=0;i--)0===s[i]&&(i!==u-1&&(e[i]=e[u-1]),--u);e.length=u,t.sort(),yield{palette:t,progress:100}}};function mi(i){const t=[];for(let e=0;e<i;e++)t[e]=0;return t}function ui(i,t,e,s){const a=new Array(i);for(let r=0;r<i;r++){a[r]=new Array(t);for(let i=0;i<t;i++){a[r][i]=new Array(e);for(let t=0;t<e;t++){a[r][i][t]=new Array(s);for(let e=0;e<s;e++)a[r][i][t][e]=0}}}return a}function oi(i,t,e){const s=new Array(i);for(let a=0;a<i;a++){s[a]=new Array(t);for(let i=0;i<t;i++){s[a][i]=new Array(e);for(let t=0;t<e;t++)s[a][i][t]=0}}return s}function li(i,t,e,s,a){for(let r=0;r<t;r++){i[r]=[];for(let t=0;t<e;t++){i[r][t]=[];for(let e=0;e<s;e++)i[r][t][e]=a}}}function _i(i,t,e){for(let s=0;s<t;s++)i[s]=e}var ci=class{constructor(){e(this,"redMinimum"),e(this,"redMaximum"),e(this,"greenMinimum"),e(this,"greenMaximum"),e(this,"blueMinimum"),e(this,"blueMaximum"),e(this,"volume"),e(this,"alphaMinimum"),e(this,"alphaMaximum")}},di=class extends H{constructor(i,t=256,s=5){super(),e(this,"_reds"),e(this,"_greens"),e(this,"_blues"),e(this,"_alphas"),e(this,"_sums"),e(this,"_weights"),e(this,"_momentsRed"),e(this,"_momentsGreen"),e(this,"_momentsBlue"),e(this,"_momentsAlpha"),e(this,"_moments"),e(this,"_table"),e(this,"_pixels"),e(this,"_cubes"),e(this,"_colors"),e(this,"_significantBitsPerChannel"),e(this,"_maxSideIndex"),e(this,"_alphaMaxSideIndex"),e(this,"_sideSize"),e(this,"_alphaSideSize"),e(this,"_distance"),this._distance=i,this._setQuality(s),this._initialize(t)}sample(i){const t=i.getPointArray();for(let i=0,e=t.length;i<e;i++)this._addColor(t[i]);this._pixels=this._pixels.concat(t)}*quantize(){yield*this._preparePalette();const i=new K;for(let t=0;t<this._colors;t++)if(this._sums[t]>0){const e=this._sums[t],s=this._reds[t]/e,a=this._greens[t]/e,r=this._blues[t]/e,n=this._alphas[t]/e,h=W.createByRGBA(0|s,0|a,0|r,0|n);i.add(h)}i.sort(),yield{palette:i,progress:100}}*_preparePalette(){yield*this._calculateMoments();let i=0;const t=mi(this._colors);for(let e=1;e<this._colors;++e){this._cut(this._cubes[i],this._cubes[e])?(t[i]=this._cubes[i].volume>1?this._calculateVariance(this._cubes[i]):0,t[e]=this._cubes[e].volume>1?this._calculateVariance(this._cubes[e]):0):(t[i]=0,e--),i=0;let s=t[0];for(let a=1;a<=e;++a)t[a]>s&&(s=t[a],i=a);if(s<=0){this._colors=e+1;break}}const e=[],s=[],a=[],r=[];for(let i=0;i<this._colors;++i){const t=di._volume(this._cubes[i],this._weights);t>0?(e[i]=di._volume(this._cubes[i],this._momentsRed)/t|0,s[i]=di._volume(this._cubes[i],this._momentsGreen)/t|0,a[i]=di._volume(this._cubes[i],this._momentsBlue)/t|0,r[i]=di._volume(this._cubes[i],this._momentsAlpha)/t|0):(e[i]=0,s[i]=0,a[i]=0,r[i]=0)}this._reds=mi(this._colors+1),this._greens=mi(this._colors+1),this._blues=mi(this._colors+1),this._alphas=mi(this._colors+1),this._sums=mi(this._colors+1);for(let i=0,t=this._pixels.length;i<t;i++){const t=this._pixels[i];let n=-1,h=Number.MAX_VALUE;for(let i=0;i<this._colors;i++){const m=e[i],u=s[i],o=a[i],l=r[i],_=this._distance.calculateRaw(m,u,o,l,t.r,t.g,t.b,t.a);_<h&&(h=_,n=i)}this._reds[n]+=t.r,this._greens[n]+=t.g,this._blues[n]+=t.b,this._alphas[n]+=t.a,this._sums[n]++}}_addColor(i){const t=8-this._significantBitsPerChannel,e=1+(i.r>>t),s=1+(i.g>>t),a=1+(i.b>>t),r=1+(i.a>>t);this._weights[r][e][s][a]++,this._momentsRed[r][e][s][a]+=i.r,this._momentsGreen[r][e][s][a]+=i.g,this._momentsBlue[r][e][s][a]+=i.b,this._momentsAlpha[r][e][s][a]+=i.a,this._moments[r][e][s][a]+=this._table[i.r]+this._table[i.g]+this._table[i.b]+this._table[i.a]}*_calculateMoments(){const i=[],t=[],e=[],s=[],a=[],r=[],n=oi(this._sideSize,this._sideSize,this._sideSize),h=oi(this._sideSize,this._sideSize,this._sideSize),m=oi(this._sideSize,this._sideSize,this._sideSize),u=oi(this._sideSize,this._sideSize,this._sideSize),o=oi(this._sideSize,this._sideSize,this._sideSize),l=oi(this._sideSize,this._sideSize,this._sideSize);let _=0;const c=new J(this._alphaMaxSideIndex*this._maxSideIndex,99);for(let d=1;d<=this._alphaMaxSideIndex;++d){li(n,this._sideSize,this._sideSize,this._sideSize,0),li(h,this._sideSize,this._sideSize,this._sideSize,0),li(m,this._sideSize,this._sideSize,this._sideSize,0),li(u,this._sideSize,this._sideSize,this._sideSize,0),li(o,this._sideSize,this._sideSize,this._sideSize,0),li(l,this._sideSize,this._sideSize,this._sideSize,0);for(let g=1;g<=this._maxSideIndex;++g,++_){c.shouldNotify(_)&&(yield{progress:c.progress}),_i(i,this._sideSize,0),_i(t,this._sideSize,0),_i(e,this._sideSize,0),_i(s,this._sideSize,0),_i(a,this._sideSize,0),_i(r,this._sideSize,0);for(let _=1;_<=this._maxSideIndex;++_){let c=0,M=0,p=0,b=0,f=0,x=0;for(let w=1;w<=this._maxSideIndex;++w)c+=this._weights[d][g][_][w],M+=this._momentsRed[d][g][_][w],p+=this._momentsGreen[d][g][_][w],b+=this._momentsBlue[d][g][_][w],f+=this._momentsAlpha[d][g][_][w],x+=this._moments[d][g][_][w],i[w]+=c,t[w]+=M,e[w]+=p,s[w]+=b,a[w]+=f,r[w]+=x,n[g][_][w]=n[g-1][_][w]+i[w],h[g][_][w]=h[g-1][_][w]+t[w],m[g][_][w]=m[g-1][_][w]+e[w],u[g][_][w]=u[g-1][_][w]+s[w],o[g][_][w]=o[g-1][_][w]+a[w],l[g][_][w]=l[g-1][_][w]+r[w],this._weights[d][g][_][w]=this._weights[d-1][g][_][w]+n[g][_][w],this._momentsRed[d][g][_][w]=this._momentsRed[d-1][g][_][w]+h[g][_][w],this._momentsGreen[d][g][_][w]=this._momentsGreen[d-1][g][_][w]+m[g][_][w],this._momentsBlue[d][g][_][w]=this._momentsBlue[d-1][g][_][w]+u[g][_][w],this._momentsAlpha[d][g][_][w]=this._momentsAlpha[d-1][g][_][w]+o[g][_][w],this._moments[d][g][_][w]=this._moments[d-1][g][_][w]+l[g][_][w]}}}}static _volumeFloat(i,t){return t[i.alphaMaximum][i.redMaximum][i.greenMaximum][i.blueMaximum]-t[i.alphaMaximum][i.redMaximum][i.greenMinimum][i.blueMaximum]-t[i.alphaMaximum][i.redMinimum][i.greenMaximum][i.blueMaximum]+t[i.alphaMaximum][i.redMinimum][i.greenMinimum][i.blueMaximum]-t[i.alphaMinimum][i.redMaximum][i.greenMaximum][i.blueMaximum]+t[i.alphaMinimum][i.redMaximum][i.greenMinimum][i.blueMaximum]+t[i.alphaMinimum][i.redMinimum][i.greenMaximum][i.blueMaximum]-t[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMaximum]-(t[i.alphaMaximum][i.redMaximum][i.greenMaximum][i.blueMinimum]-t[i.alphaMinimum][i.redMaximum][i.greenMaximum][i.blueMinimum]-t[i.alphaMaximum][i.redMaximum][i.greenMinimum][i.blueMinimum]+t[i.alphaMinimum][i.redMaximum][i.greenMinimum][i.blueMinimum]-t[i.alphaMaximum][i.redMinimum][i.greenMaximum][i.blueMinimum]+t[i.alphaMinimum][i.redMinimum][i.greenMaximum][i.blueMinimum]+t[i.alphaMaximum][i.redMinimum][i.greenMinimum][i.blueMinimum]-t[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMinimum])}static _volume(i,t){return 0|di._volumeFloat(i,t)}static _top(i,t,e,s){let a;switch(t){case di._alpha:a=s[e][i.redMaximum][i.greenMaximum][i.blueMaximum]-s[e][i.redMaximum][i.greenMinimum][i.blueMaximum]-s[e][i.redMinimum][i.greenMaximum][i.blueMaximum]+s[e][i.redMinimum][i.greenMinimum][i.blueMaximum]-(s[e][i.redMaximum][i.greenMaximum][i.blueMinimum]-s[e][i.redMaximum][i.greenMinimum][i.blueMinimum]-s[e][i.redMinimum][i.greenMaximum][i.blueMinimum]+s[e][i.redMinimum][i.greenMinimum][i.blueMinimum]);break;case di._red:a=s[i.alphaMaximum][e][i.greenMaximum][i.blueMaximum]-s[i.alphaMaximum][e][i.greenMinimum][i.blueMaximum]-s[i.alphaMinimum][e][i.greenMaximum][i.blueMaximum]+s[i.alphaMinimum][e][i.greenMinimum][i.blueMaximum]-(s[i.alphaMaximum][e][i.greenMaximum][i.blueMinimum]-s[i.alphaMaximum][e][i.greenMinimum][i.blueMinimum]-s[i.alphaMinimum][e][i.greenMaximum][i.blueMinimum]+s[i.alphaMinimum][e][i.greenMinimum][i.blueMinimum]);break;case di._green:a=s[i.alphaMaximum][i.redMaximum][e][i.blueMaximum]-s[i.alphaMaximum][i.redMinimum][e][i.blueMaximum]-s[i.alphaMinimum][i.redMaximum][e][i.blueMaximum]+s[i.alphaMinimum][i.redMinimum][e][i.blueMaximum]-(s[i.alphaMaximum][i.redMaximum][e][i.blueMinimum]-s[i.alphaMaximum][i.redMinimum][e][i.blueMinimum]-s[i.alphaMinimum][i.redMaximum][e][i.blueMinimum]+s[i.alphaMinimum][i.redMinimum][e][i.blueMinimum]);break;case di._blue:a=s[i.alphaMaximum][i.redMaximum][i.greenMaximum][e]-s[i.alphaMaximum][i.redMaximum][i.greenMinimum][e]-s[i.alphaMaximum][i.redMinimum][i.greenMaximum][e]+s[i.alphaMaximum][i.redMinimum][i.greenMinimum][e]-(s[i.alphaMinimum][i.redMaximum][i.greenMaximum][e]-s[i.alphaMinimum][i.redMaximum][i.greenMinimum][e]-s[i.alphaMinimum][i.redMinimum][i.greenMaximum][e]+s[i.alphaMinimum][i.redMinimum][i.greenMinimum][e]);break;default:throw new Error("impossible")}return 0|a}static _bottom(i,t,e){switch(t){case di._alpha:return-e[i.alphaMinimum][i.redMaximum][i.greenMaximum][i.blueMaximum]+e[i.alphaMinimum][i.redMaximum][i.greenMinimum][i.blueMaximum]+e[i.alphaMinimum][i.redMinimum][i.greenMaximum][i.blueMaximum]-e[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMaximum]-(-e[i.alphaMinimum][i.redMaximum][i.greenMaximum][i.blueMinimum]+e[i.alphaMinimum][i.redMaximum][i.greenMinimum][i.blueMinimum]+e[i.alphaMinimum][i.redMinimum][i.greenMaximum][i.blueMinimum]-e[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMinimum]);case di._red:return-e[i.alphaMaximum][i.redMinimum][i.greenMaximum][i.blueMaximum]+e[i.alphaMaximum][i.redMinimum][i.greenMinimum][i.blueMaximum]+e[i.alphaMinimum][i.redMinimum][i.greenMaximum][i.blueMaximum]-e[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMaximum]-(-e[i.alphaMaximum][i.redMinimum][i.greenMaximum][i.blueMinimum]+e[i.alphaMaximum][i.redMinimum][i.greenMinimum][i.blueMinimum]+e[i.alphaMinimum][i.redMinimum][i.greenMaximum][i.blueMinimum]-e[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMinimum]);case di._green:return-e[i.alphaMaximum][i.redMaximum][i.greenMinimum][i.blueMaximum]+e[i.alphaMaximum][i.redMinimum][i.greenMinimum][i.blueMaximum]+e[i.alphaMinimum][i.redMaximum][i.greenMinimum][i.blueMaximum]-e[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMaximum]-(-e[i.alphaMaximum][i.redMaximum][i.greenMinimum][i.blueMinimum]+e[i.alphaMaximum][i.redMinimum][i.greenMinimum][i.blueMinimum]+e[i.alphaMinimum][i.redMaximum][i.greenMinimum][i.blueMinimum]-e[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMinimum]);case di._blue:return-e[i.alphaMaximum][i.redMaximum][i.greenMaximum][i.blueMinimum]+e[i.alphaMaximum][i.redMaximum][i.greenMinimum][i.blueMinimum]+e[i.alphaMaximum][i.redMinimum][i.greenMaximum][i.blueMinimum]-e[i.alphaMaximum][i.redMinimum][i.greenMinimum][i.blueMinimum]-(-e[i.alphaMinimum][i.redMaximum][i.greenMaximum][i.blueMinimum]+e[i.alphaMinimum][i.redMaximum][i.greenMinimum][i.blueMinimum]+e[i.alphaMinimum][i.redMinimum][i.greenMaximum][i.blueMinimum]-e[i.alphaMinimum][i.redMinimum][i.greenMinimum][i.blueMinimum]);default:return 0}}_calculateVariance(i){const t=di._volume(i,this._momentsRed),e=di._volume(i,this._momentsGreen),s=di._volume(i,this._momentsBlue),a=di._volume(i,this._momentsAlpha);return di._volumeFloat(i,this._moments)-(t*t+e*e+s*s+a*a)/di._volume(i,this._weights)}_maximize(i,t,e,s,a,r,n,h,m){const u=0|di._bottom(i,t,this._momentsRed),o=0|di._bottom(i,t,this._momentsGreen),l=0|di._bottom(i,t,this._momentsBlue),_=0|di._bottom(i,t,this._momentsAlpha),c=0|di._bottom(i,t,this._weights);let d=0,g=-1;for(let M=e;M<s;++M){let e=u+di._top(i,t,M,this._momentsRed),s=o+di._top(i,t,M,this._momentsGreen),p=l+di._top(i,t,M,this._momentsBlue),b=_+di._top(i,t,M,this._momentsAlpha),f=c+di._top(i,t,M,this._weights);if(0!==f){let i=e*e+s*s+p*p+b*b,t=i/f;e=a-e,s=r-s,p=n-p,b=h-b,f=m-f,0!==f&&(i=e*e+s*s+p*p+b*b,t+=i/f,t>d&&(d=t,g=M))}}return{max:d,position:g}}_cut(i,t){let e;const s=di._volume(i,this._momentsRed),a=di._volume(i,this._momentsGreen),r=di._volume(i,this._momentsBlue),n=di._volume(i,this._momentsAlpha),h=di._volume(i,this._weights),m=this._maximize(i,di._red,i.redMinimum+1,i.redMaximum,s,a,r,n,h),u=this._maximize(i,di._green,i.greenMinimum+1,i.greenMaximum,s,a,r,n,h),o=this._maximize(i,di._blue,i.blueMinimum+1,i.blueMaximum,s,a,r,n,h),l=this._maximize(i,di._alpha,i.alphaMinimum+1,i.alphaMaximum,s,a,r,n,h);if(l.max>=m.max&&l.max>=u.max&&l.max>=o.max){if(e=di._alpha,l.position<0)return!1}else e=m.max>=l.max&&m.max>=u.max&&m.max>=o.max?di._red:u.max>=l.max&&u.max>=m.max&&u.max>=o.max?di._green:di._blue;switch(t.redMaximum=i.redMaximum,t.greenMaximum=i.greenMaximum,t.blueMaximum=i.blueMaximum,t.alphaMaximum=i.alphaMaximum,e){case di._red:t.redMinimum=i.redMaximum=m.position,t.greenMinimum=i.greenMinimum,t.blueMinimum=i.blueMinimum,t.alphaMinimum=i.alphaMinimum;break;case di._green:t.greenMinimum=i.greenMaximum=u.position,t.redMinimum=i.redMinimum,t.blueMinimum=i.blueMinimum,t.alphaMinimum=i.alphaMinimum;break;case di._blue:t.blueMinimum=i.blueMaximum=o.position,t.redMinimum=i.redMinimum,t.greenMinimum=i.greenMinimum,t.alphaMinimum=i.alphaMinimum;break;case di._alpha:t.alphaMinimum=i.alphaMaximum=l.position,t.blueMinimum=i.blueMinimum,t.redMinimum=i.redMinimum,t.greenMinimum=i.greenMinimum}return i.volume=(i.redMaximum-i.redMinimum)*(i.greenMaximum-i.greenMinimum)*(i.blueMaximum-i.blueMinimum)*(i.alphaMaximum-i.alphaMinimum),t.volume=(t.redMaximum-t.redMinimum)*(t.greenMaximum-t.greenMinimum)*(t.blueMaximum-t.blueMinimum)*(t.alphaMaximum-t.alphaMinimum),!0}_initialize(i){this._colors=i,this._cubes=[];for(let t=0;t<i;t++)this._cubes[t]=new ci;this._cubes[0].redMinimum=0,this._cubes[0].greenMinimum=0,this._cubes[0].blueMinimum=0,this._cubes[0].alphaMinimum=0,this._cubes[0].redMaximum=this._maxSideIndex,this._cubes[0].greenMaximum=this._maxSideIndex,this._cubes[0].blueMaximum=this._maxSideIndex,this._cubes[0].alphaMaximum=this._alphaMaxSideIndex,this._weights=ui(this._alphaSideSize,this._sideSize,this._sideSize,this._sideSize),this._momentsRed=ui(this._alphaSideSize,this._sideSize,this._sideSize,this._sideSize),this._momentsGreen=ui(this._alphaSideSize,this._sideSize,this._sideSize,this._sideSize),this._momentsBlue=ui(this._alphaSideSize,this._sideSize,this._sideSize,this._sideSize),this._momentsAlpha=ui(this._alphaSideSize,this._sideSize,this._sideSize,this._sideSize),this._moments=ui(this._alphaSideSize,this._sideSize,this._sideSize,this._sideSize),this._table=[];for(let i=0;i<256;++i)this._table[i]=i*i;this._pixels=[]}_setQuality(i=5){this._significantBitsPerChannel=i,this._maxSideIndex=1<<this._significantBitsPerChannel,this._alphaMaxSideIndex=this._maxSideIndex,this._sideSize=this._maxSideIndex+1,this._alphaSideSize=this._alphaMaxSideIndex+1}},gi=di;e(gi,"_alpha",3),e(gi,"_red",2),e(gi,"_green",1),e(gi,"_blue",0);t({},{AbstractImageQuantizer:()=>Mi,ErrorDiffusionArray:()=>fi,ErrorDiffusionArrayKernel:()=>bi,ErrorDiffusionRiemersma:()=>yi,NearestColor:()=>pi});var Mi=class{quantizeSync(i,t){for(const e of this.quantize(i,t))if(e.pointContainer)return e.pointContainer;throw new Error("unreachable")}},pi=class extends Mi{constructor(i){super(),e(this,"_distance"),this._distance=i}*quantize(i,t){const e=i.getPointArray(),s=i.getWidth(),a=i.getHeight(),r=new J(a,99);for(let i=0;i<a;i++){r.shouldNotify(i)&&(yield{progress:r.progress});for(let a=0,r=i*s;a<s;a++,r++){const i=e[r];i.from(t.getNearestColor(this._distance,i))}}yield{pointContainer:i,progress:100}}},bi=(i=>(i[i.FloydSteinberg=0]="FloydSteinberg",i[i.FalseFloydSteinberg=1]="FalseFloydSteinberg",i[i.Stucki=2]="Stucki",i[i.Atkinson=3]="Atkinson",i[i.Jarvis=4]="Jarvis",i[i.Burkes=5]="Burkes",i[i.Sierra=6]="Sierra",i[i.TwoSierra=7]="TwoSierra",i[i.SierraLite=8]="SierraLite",i))(bi||{}),fi=class extends Mi{constructor(i,t,s=!0,a=0,r=!1){super(),e(this,"_minColorDistance"),e(this,"_serpentine"),e(this,"_kernel"),e(this,"_calculateErrorLikeGIMP"),e(this,"_distance"),this._setKernel(t),this._distance=i,this._minColorDistance=a,this._serpentine=s,this._calculateErrorLikeGIMP=r}*quantize(i,t){const e=i.getPointArray(),s=new W,a=i.getWidth(),r=i.getHeight(),n=[];let h=1,m=1;for(const i of this._kernel){const t=i[2]+1;m<t&&(m=t)}for(let i=0;i<m;i++)this._fillErrorLine(n[i]=[],a);const u=new J(r,99);for(let i=0;i<r;i++){u.shouldNotify(i)&&(yield{progress:u.progress}),this._serpentine&&(h*=-1);const m=i*a,o=1===h?0:a-1,l=1===h?a:-1;this._fillErrorLine(n[0],a),n.push(n.shift());const _=n[0];for(let u=o,c=m+o;u!==l;u+=h,c+=h){const m=e[c],o=_[u];s.from(m);const l=W.createByRGBA(d(m.r+o[0]),d(m.g+o[1]),d(m.b+o[2]),d(m.a+o[3])),g=t.getNearestColor(this._distance,l);if(m.from(g),this._minColorDistance){if(this._distance.calculateNormalized(s,g)<this._minColorDistance)continue}let M,p,b,f;this._calculateErrorLikeGIMP?(M=l.r-g.r,p=l.g-g.g,b=l.b-g.b,f=l.a-g.a):(M=s.r-g.r,p=s.g-g.g,b=s.b-g.b,f=s.a-g.a);const x=1===h?0:this._kernel.length-1,w=1===h?this._kernel.length:-1;for(let t=x;t!==w;t+=h){const e=this._kernel[t][1]*h,s=this._kernel[t][2];if(e+u>=0&&e+u<a&&s+i>=0&&s+i<r){const i=this._kernel[t][0],a=n[s][e+u];a[0]+=M*i,a[1]+=p*i,a[2]+=b*i,a[3]+=f*i}}}}yield{pointContainer:i,progress:100}}_fillErrorLine(i,t){i.length>t&&(i.length=t);const e=i.length;for(let t=0;t<e;t++){const e=i[t];e[0]=e[1]=e[2]=e[3]=0}for(let s=e;s<t;s++)i[s]=[0,0,0,0]}_setKernel(i){switch(i){case 0:this._kernel=[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]];break;case 1:this._kernel=[[3/8,1,0],[3/8,0,1],[2/8,1,1]];break;case 2:this._kernel=[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]];break;case 3:this._kernel=[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]];break;case 4:this._kernel=[[7/48,1,0],[5/48,2,0],[3/48,-2,1],[5/48,-1,1],[7/48,0,1],[5/48,1,1],[3/48,2,1],[1/48,-2,2],[3/48,-1,2],[5/48,0,2],[3/48,1,2],[1/48,2,2]];break;case 5:this._kernel=[[.25,1,0],[4/32,2,0],[2/32,-2,1],[4/32,-1,1],[.25,0,1],[4/32,1,1],[2/32,2,1]];break;case 6:this._kernel=[[5/32,1,0],[3/32,2,0],[2/32,-2,1],[4/32,-1,1],[5/32,0,1],[4/32,1,1],[2/32,2,1],[2/32,-1,2],[3/32,0,2],[2/32,1,2]];break;case 7:this._kernel=[[.25,1,0],[3/16,2,0],[1/16,-2,1],[2/16,-1,1],[3/16,0,1],[2/16,1,1],[1/16,2,1]];break;case 8:this._kernel=[[.5,1,0],[1/4,-1,1],[1/4,0,1]];break;default:throw new Error(`ErrorDiffusionArray: unknown kernel = ${i}`)}}};function*xi(i,t,e){const s=Math.max(i,t),a={width:i,height:t,level:Math.floor(Math.log(s)/Math.log(2)+1),callback:e,tracker:new J(i*t,99),index:0,x:0,y:0};yield*wi(a,1),Si(a,0)}function*wi(i,t){if(!(i.level<1)){switch(i.tracker.shouldNotify(i.index)&&(yield{progress:i.tracker.progress}),i.level--,t){case 2:yield*wi(i,1),Si(i,3),yield*wi(i,2),Si(i,4),yield*wi(i,2),Si(i,2),yield*wi(i,4);break;case 3:yield*wi(i,4),Si(i,2),yield*wi(i,3),Si(i,1),yield*wi(i,3),Si(i,3),yield*wi(i,1);break;case 1:yield*wi(i,2),Si(i,4),yield*wi(i,1),Si(i,3),yield*wi(i,1),Si(i,1),yield*wi(i,3);break;case 4:yield*wi(i,3),Si(i,1),yield*wi(i,4),Si(i,2),yield*wi(i,4),Si(i,4),yield*wi(i,2)}i.level++}}function Si(i,t){switch(i.x>=0&&i.x<i.width&&i.y>=0&&i.y<i.height&&(i.callback(i.x,i.y),i.index++),t){case 2:i.x--;break;case 3:i.x++;break;case 1:i.y--;break;case 4:i.y++}}var yi=class extends Mi{constructor(i,t=16,s=1){super(),e(this,"_distance"),e(this,"_weights"),e(this,"_errorQueueSize"),this._distance=i,this._errorQueueSize=t,this._weights=yi._createWeights(s,t)}*quantize(i,t){const e=i.getPointArray(),s=i.getWidth(),a=i.getHeight(),r=[];let n=0;for(let i=0;i<this._errorQueueSize;i++)r[i]={r:0,g:0,b:0,a:0};yield*xi(s,a,((i,a)=>{const h=e[i+a*s];let{r:m,g:u,b:o,a:l}=h;for(let i=0;i<this._errorQueueSize;i++){const t=this._weights[i],e=r[(i+n)%this._errorQueueSize];m+=e.r*t,u+=e.g*t,o+=e.b*t,l+=e.a*t}const _=W.createByRGBA(d(m),d(u),d(o),d(l)),c=t.getNearestColor(this._distance,_);n=(n+1)%this._errorQueueSize;const g=(n+this._errorQueueSize-1)%this._errorQueueSize;r[g].r=h.r-c.r,r[g].g=h.g-c.g,r[g].b=h.b-c.b,r[g].a=h.a-c.a,h.from(c)})),yield{pointContainer:i,progress:100}}static _createWeights(i,t){const e=[],s=Math.exp(Math.log(t)/(t-1));for(let a=0,r=1;a<t;a++)e[a]=(r+.5|0)/t*i,r*=s;return e}};t({},{ssim:()=>ki});function ki(i,t){if(i.getHeight()!==t.getHeight()||i.getWidth()!==t.getWidth())throw new Error("Images have different sizes!");const e=(.01*255)**2,s=(.03*255)**2;let a=0,r=0;return function(i,t,e){const s=8,a=i.getWidth(),r=i.getHeight();for(let n=0;n<r;n+=s)for(let h=0;h<a;h+=s){const m=Math.min(s,a-h),u=Math.min(s,r-n),o=zi(i,h,n,m,u),l=zi(t,h,n,m,u);e(o,l,Ai(o),Ai(l))}}(i,t,((i,t,n,h)=>{let m=0,u=0,o=0;for(let e=0;e<i.length;e++)u+=(i[e]-n)**2,o+=(t[e]-h)**2,m+=(i[e]-n)*(t[e]-h);const l=i.length-1;u/=l,o/=l,m/=l;r+=(2*n*h+e)*(2*m+s)/((n**2+h**2+e)*(u+o+s)),a++})),r/a}function zi(i,t,e,s,a){const r=i.getPointArray(),n=[];let h=0;for(let m=e;m<e+a;m++){const e=m*i.getWidth();for(let i=t;i<t+s;i++){const t=r[e+i];n[h]=.2126*t.r+.7152*t.g+.0722*t.b,h++}}return n}function Ai(i){let t=0;for(const e of i)t+=e;return t/i.length}"function"==typeof setImmediate?setImmediate:"undefined"!=typeof process&&(null==process||process.nextTick);function Bi(i="euclidean-bt709"){switch(i){case"cie94-graphic-arts":return new R;case"cie94-textiles":return new P;case"ciede2000":return new E;case"color-metric":return new C;case"euclidean":return new D;case"euclidean-bt709":return new G;case"euclidean-bt709-noalpha":return new q;case"manhattan":return new U;case"manhattan-bt709":return new Q;case"manhattan-nommyde":return new L;case"pngquant":return new T;default:throw new Error(`Unknown colorDistanceFormula ${i}`)}}function Pi(i,t="floyd-steinberg"){switch(t){case"nearest":return new pi(i);case"riemersma":return new yi(i);case"floyd-steinberg":return new fi(i,0);case"false-floyd-steinberg":return new fi(i,1);case"stucki":return new fi(i,2);case"atkinson":return new fi(i,3);case"jarvis":return new fi(i,4);case"burkes":return new fi(i,5);case"sierra":return new fi(i,6);case"two-sierra":return new fi(i,7);case"sierra-lite":return new fi(i,8);default:throw new Error(`Unknown imageQuantization ${t}`)}}function Ri(i,t="wuquant",e=256){switch(t){case"neuquant":return new ii(i,e);case"rgbquant":return new hi(i,e);case"wuquant":return new gi(i,e);case"neuquant-float":return new si(i,e);default:throw new Error(`Unknown paletteQuantization ${t}`)}}function Ii(i){return i.map((i=>i.r<<16|i.g<<8|i.b))}function Ei(i,t,e,s,a){const r=function(i,t,e){let s=0;const a=t*e*4,r=new Set;for(;s<a;){const t=i[s++],e=i[s++],a=i[s++];s++;const n=t<<16|e<<8|a;r.add(n)}let n=0;for(;n<16777215&&r.has(n);)n++;return n}(i,t,e),{rgba:n,hasTransparency:h}=function(i,t,e,s,a=.7){let r=0;const n=t*e*4,h=[],m=Math.trunc(255*a);let u=!1;const o=(16711680&s)>>16,l=(65280&s)>>8,_=255&s;for(;r<n;){const t=i[r++],e=i[r++],a=i[r++];let n=i[r++];n=n>=m?255:0,void 0!==s&&0===n?(h.push(o),h.push(l),h.push(_),h.push(0),u=!0):(h.push(t),h.push(e),h.push(a),h.push(255))}return{rgba:h,hasTransparency:u}}(i,t,e,r,s),m=O.PointContainer.fromUint8Array(new Uint8Array(n),t,e),u=function(i,{colorDistanceFormula:t,paletteQuantization:e,colors:s}={}){const a=Ri(Bi(t),e,s);return i.forEach((i=>a.sample(i))),a.quantizeSync()}([m],{paletteQuantization:"rgbquant",colors:h&&r?255:256});h&&r&&u.add(O.Point.createByUint32(r));const o=function(i,t,{colorDistanceFormula:e,imageQuantization:s}={}){return Pi(Bi(e),s).quantizeSync(i,t)}(m,u,{imageQuantization:a}),l=Ii(u.getPointContainer().getPointArray());l.sort(((i,t)=>i-t));const _=l.indexOf(r),c=function(i,t){return Uint8Array.from(i.map((i=>t.indexOf(i))))}(Ii(o.getPointArray()),l);return{pixels:c,palette:Array.from(l),transparencyIndex:_>-1?_:void 0}}self.onmessage=function(i){var t=function(i){const{width:t,height:e,data:s,dithering:a,transparencyCutOff:r}=i;return Ei(s,t,e,r,a)}(i.data);postMessage(t)}})();',"Worker",void 0,void 0)}const n=function(t){let e=(t=t||{}).width||160,s=t.height||120;const a=t.dithering||void 0,n=t.palette||null,h=t.disposal||0,o=t.transparencyCutOff||.7;let m=null,u=null,l=0,_=250;const c=[];let d,g=0,f=function(){},p=function(){},M=[],b=[],w=!1;if(n){if(!(n instanceof Array))throw n;if(n.length<2||n.length>256){for(console.error("Palette must hold only between 2 and 256 colours");n.length<2;)n.push(0);n.length>256&&(n=n.slice(0,256))}if(!A(n.length))for(console.error("Palette must have a power of two number of colours");!A(n.length);)n.splice(n.length-1,1)}d=(t=t||{}).numWorkers||2;for(let i=0;i<d;i++){const i=new r;M.push(i),b.push(i)}const x=function(){let i=[];for(let t=0;t<256;t++)i[t]=String.fromCharCode(t);return function(t){const e=t.length;let s="";for(let a=0;a<e;a++)s+=i[t[a]];return s}}();function y(i){f=i;for(let i=0;i<d&&i<c.length;i++)S(i)}function S(i){let t,e;if(t=c[i],t.beingProcessed||t.done)return console.error("Frame already being processed or done!",t.position),void z();t.beingProcessed=!0,e=function(){if(0===b.length)throw"No workers left!";return b.pop()}(),e.onmessage=function(i){const s=i.data;delete t.data,t.pixels=Array.prototype.slice.call(s.pixels),t.palette=Array.prototype.slice.call(s.palette),t.transparencyIndex=s.transparencyIndex,t.done=!0,t.beingProcessed=!1,function(i){b.push(i)}(e),z()},e.postMessage(t)}function k(){let i=-1;for(let e=0;e<c.length;e++){var t=c[e];if(!t.done&&!t.beingProcessed){i=e;break}}i>=0&&S(i)}function z(){const t=c.every((function(i){return!i.beingProcessed&&i.done}));g++,p(.75*g/c.length),t?w||function(t,r){const h=[],o={loop:l};null!==a&&null!==n&&(o.palette=n);const m=new i.g(h,e,s,o);w=!0,t.forEach((function(i){let a=n||i.palette;for(p(.75+.25*i.position*1/t.length);!A(a.length)&&a.length<256;)a.push(0);m.addFrame(0,0,e,s,i.pixels,{palette:a,delay:_,transparent:i.transparencyIndex,disposal:i.disposal})})),m.end(),p(1),t=[],w=!1,r(h)}(c,f):setTimeout(k,1)}function A(i){return 0!==i&&0==(i&i-1)}this.setSize=function(i,t){e=i,s=t,m=document.createElement("canvas"),m.width=i,m.height=t,u=m.getContext("2d")},this.setDelay=function(i){_=.1*i},this.setRepeat=function(i){l=i},this.addFrame=function(i,t={}){null===u&&this.setSize(e,s),u.clearRect(0,0,e,s),u.drawImage(i,0,0,e,s);const a=u.getImageData(0,0,e,s);this.addFrameImageData(a,t)},this.addFrameImageData=function(i,t={}){const e=new Uint8Array(i.data);c.push({data:e,width:i.width,height:i.height,palette:t.palette||n,dithering:t.dithering||a,disposal:t.disposal||h,transparencyCutOff:t.transparencyCutOff||o,done:!1,beingProcessed:!1,position:c.length})},this.onRenderProgress=function(i){p=i},this.isRendering=function(){return w},this.getBase64GIF=function(i){y((function(t){const e=x(t),s="data:image/gif;base64,"+btoa(e);i(s)}))},this.getBlobGIF=function(i){y((function(t){const e=new Uint8Array(t),s=new Blob([e],{type:"image/gif"});i(s)}))},this.destroy=function(){M.forEach((function(i){i.terminate()}))}}})(),s})()}));